<html>
<head>
  <meta charset="UTF-8">
  <title>Pivotal Stats</title>
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.2/normalize.min.css">
  <link rel="stylesheet" type="text/css" href="/css/app.css">
  <!-- JS -->
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>
</head>
<body>

  <div class="wrapper">
    <div class="users"></div>
  </div>

  <script id="projects-template" type="text/x-handlebars-template">
    {{#each this}}
      <div id="{{ name }}" class="project">
        <h3>{{ name }}: {{ id }}</h3>
        <div class="clearfix">
          <div class="backlog pie">Loading...</div>
          <div class="current pie">Loading...</div>
          <div class="done pie">Loading...</div>
        </div>
      </div>
    {{/each}}
  </script>

  <script id="user-stats-template-2" type="text/x-handlebars-template">
    {{#each data}}
    <div class="user">
      <div class="tasks current">
        {{#each this.current.bugs}}
          <div class="task bugs {{this.state}}"></div>
        {{/each}}
        {{#each this.current.chores}}
          <div class="task chores {{this.state}}"></div>
        {{/each}}
        {{#each this.current.features}}
          <div class="task features {{this.state}}" style="height: {{math this.estimate "*" 10 }}px;"></div>
        {{/each}}
      </div>

      <!-- <p>{{ this.name }}</p> -->
      <div class="user-meta">{{ this.initials }}</div>

      <div class="tasks backlog">
        {{#each this.backlog.features}}
          <div class="task features {{this.state}}" style="height: {{math this.estimate "*" 10 }}px;"></div>
        {{/each}}
        {{#each this.backlog.chores}}
          <div class="task chores {{this.state}}"></div>
        {{/each}}
        {{#each this.backlog.bugs}}
          <div class="task bugs {{this.state}}"></div>
        {{/each}}
      </div>

    </div>
    {{/each}}
  </script>

  <script src="/javascript/helpers.js"></script>
  <script type="text/javascript">

    var getProjectData = function(id, cb) {
      $.ajax({
        url: 'http://localhost:8999/api/project/'+ id,
        type: 'GET',
        dataType: 'json'
      }).done(function(res) {
        var obj = res.data;
        cb(obj);
      });
    };

    var getGraph = function(data, type) {
      getProjectIteration(data, type, function(d) {
        initHighcharts($('#'+ d.name).find('.'+ type), type, d);
      });
    };

    $(function() {

      var fullUrl = document.URL;
      var urlArray = fullUrl.split('/');
      var projectID = urlArray[urlArray.length-1];
      console.log( projectID );

      getProjectData(projectID, function(data) {
        var source   = $('#projects-template').html();
        var template = Handlebars.compile(source);
        var html     = template([data]);
        $('.wrapper').prepend(html);

        getGraph(data, 'backlog');
        getGraph(data, 'current');
        getGraph(data, 'done');
      });

      getUserStats(projectID, function(data) {
        createUserStats(data);
      });
    });
  </script>

</body>
</html>
